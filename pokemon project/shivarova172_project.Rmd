---
title: "Проект по дисциплине основы программирования в R"
author: "Katya Schivarova"
date: "6/10/2020"
output: html_document
---
# Все о покемонах 


## Работа с данными

Для исследовательской работы были использованы открытые данные с портала Kaggle [Pokemon](https://www.kaggle.com/abcsds/pokemon/data). Об операционализации переменных будет далее сказано в Codebook. В исследовании было выдвинуто две гипотезы: 

1. Легендарность положительно связана со всеми показателями покемона
2. Нет стихии или поколения, которое бы концентрировало всех легендарных покемонов 

Подгружаем библиотеки и добавляем данные. Даем пустым ячейкам значение  NA, через замену в аттрибуте na.strings, так как отсутствие символов R читает как заполненную ячейку. 

```{r }
library(tidyverse)
library(vioplot)
library(VIM)
pokemon <- read.csv('pokemon.csv', na.strings=c("","NA"))
```

При помощи библиотеки tidyverse удаляем из исходного датафрейма столбец с нумерацией при помощи функции mutate. Делаем переменную Legendary бинарной, а Generation факторной. Исходное имя покемона делаем типом character. Переменную второго типа стихии покемона убираем для упрощения анализа. Более того, этой характеристикой обладают немногие покемоны. 

```{r }
pokemon <- pokemon %>% select(-c(X.,Type.2)) %>% 
  mutate(Generation = as.factor(Generation)) %>% mutate(Legendary = ifelse(Legendary == "True", 1, 0)) %>% mutate(Legendary =
      as.factor(Legendary)) %>% mutate(Name = as.character(Name))
```

## Описание датафрейма

Как можно видеть, размерность датафрейма 800 строк и 11 столбцов. Пропущенных значений нет.

```{r }
dim(pokemon)
sum(complete.cases(pokemon))
sum(is.na(pokemon))
```

Далее структура датафрейма: можно видеть, что имя покемона - единственная переменная типа character. Среди числовых переменных показатели боеспособности покемона и скорости. Факторными переменными являются поколение (6 уровней), типы первой стихии (18 уровней). "Легендарность" является бинарной характеристикой. 

```{r }
str(pokemon)
```

Среди качественных переменных имя покемонов и тип первой стихии (всего их 18)

```{r }
head(pokemon$Name)
unique(pokemon$Type.1)
```





Так как в датафрейме нет пропущенных значений, то паттернов тоже нет. 

```{r }
aggr(pokemon)
```

## Описательные статистики

Посмотрим на описательные статистики для всех переменных в датафрейме, затем разберемся с переменными интереса. Для нас это поколение, результирующая (Total) и тип. Остальные числовые элементы входят в результирующую, поэтому охарактеризуем их при помощи описательных статистик.

  - **HP**
    варьируется от 1 до 255, с медианным значением 65, а средним 69.3
  - **Attack**
    варьируется от 5 до 190, с медианным значением 75, а средним 79
  - **Defense**
    варьируется от 5 до 230, с медианным значением 70, а средним 73.84
  - **Speed Attack**
    варьируется от 10 до 194, с медианным значением 65, а средним 72.8
  - **Speed Defense**
    варьируется от 20 до 230, с медианным значением 70, а средним 71.9
   
   




```{r }
summary(pokemon)
```




### Тип покемона (Type.1)

Используем столбчатую диаграмму. Аргументом *width* регулируем ширину столбцов, затем даем заголовок графику и осям. Переворачиваем типы для удобства восприятия. 

```{r}
ggplot(pokemon, aes(x=(Type.1)))+
  geom_bar(stat="count", width=0.7, fill="yellow") + labs(title = "Распределение типов покемонов", 
       x = "", 
       y = "Количество")+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

###  Generation 

Посмотрим как в процентном соотношении распределились покемоны по поколениям (всего их шесть) среди выборки. Строим при помощи функции *pie*, в качестве названий используем высчитанные ранее процентные соотношения в каждом поколении. 

```{r}
type <- as.data.frame(table(pokemon$Generation))
perc <- round((type$Freq)/sum(type$Freq) * 100, 1)
perc1 <- paste(perc, "%", sep="")
a <- paste(c(1,2,3,4,5,6), 'поколение покемонов')
perc_lab <- paste(a, perc1, sep = ':')
pie(table(pokemon$Generation),  main = '', labels = perc_lab, col = rainbow(length(perc_lab)))

```

### Total

Построим график распределения показателя Total (суммирует все боевые и скоростные характеристики покемона в зависимости от его поколения). Строим сглаженный график плотности распреления с группировкой по поколениям. По графику можно наблюдать, что второе и третье поколение имеют более низкую и равномерную результирующую, тогда как структура остальных допускает пики и оказывается выше. Максимума достигает пятое поколение. 

При построении графика используем аттрибут *geom_rug*, засечки, для того чтобы график был более информативным. 

```{r}
ggplot(pokemon, aes(Total, group = Generation, fill = Generation)) + geom_density(alpha = 0.5, show.legend = FALSE) + geom_rug() + facet_wrap(~Generation) + labs(title = "График плотности результирующей покемонов разных поколений", x = "Результирующая (Total)", y = "Плотность")
```

# Legendary 

Построим график, связывающий скорость покемона и его легендарность. 
Скрипичные диаграммы показывают, что количество нелегендарных покемонов больше, чем легендарных.Помимо того, становится понятно, что скорость легендарных покемонов как правило выше, чем скорость обычных. Такие же сделаем для всех компонент Total.

```{r}

new_labels <- c("Не легендарные", "Легендарные")
names(new_labels) <- c("0", "1")

ggplot(pokemon, aes(x = '', y = Speed, group = Legendary, fill =  Legendary)) +
geom_violin(alpha = 0.7, show.legend = FALSE) + facet_wrap(~Legendary, labeller = labeller(Legendary = new_labels)) +labs(title = "Распределение скорости покемонов по критерию легендарности", x = "", y = "Скорость")


```
Чтобы убедиться посчитаем эту скорость: группируем данные по легендарности, затем просчитываем описательные статистики: 
```{r }
pokemon %>% group_by(Legendary) %>% summarise('среднее' = mean(Speed), 
                                              'медиана' = median(Speed),
                                              'минимум' = min(Speed),
                                              'максимум' = max(Speed))
```

Можно видеть, что легендарные покемоны как правило быстрее обычных. Однако и среди обычных попадаются довольно быстрые (дельта максимумов каждой из групп 20 у.е.). В большинстве случаев нелегендарные покемоны медленнее: у них 64 против 100 в значении медианы. Построим такие же графики для других числовых показателей. 

```{r}
ggplot(pokemon, aes(x = '', y = Attack, group = Legendary, fill =  Legendary)) +
geom_violin(alpha = 0.7, show.legend = FALSE) + facet_wrap(~Legendary, labeller = labeller(Legendary = new_labels)) +labs(title = "Распределение скорости покемонов по критерию легендарности", x = "", y = "Сила аттаки (Attack)")
```

```{r}

ggplot(pokemon, aes(x = '', y = Speed, group = Legendary, fill =  Legendary)) +
geom_violin(alpha = 0.7, show.legend = FALSE) + facet_wrap(~Legendary, labeller = labeller(Legendary = new_labels)) +labs(title = "Распределение скорости покемонов по критерию легендарности", x = "", y = "Сила  защиты (Defense)")

```


```{r}
ggplot(pokemon, aes(x = '', y = HP, group = Legendary, fill =  Legendary)) +
geom_violin(alpha = 0.7, show.legend = FALSE) + facet_wrap(~Legendary, labeller = labeller(Legendary = new_labels)) +labs(title = "Распределение скорости покемонов по критерию легендарности", x = "", y = "HP")

```

```{r}
ggplot(pokemon, aes(x = '', y = Sp..Atk, group = Legendary, fill =  Legendary)) +
geom_violin(alpha = 0.7, show.legend = FALSE) + facet_wrap(~Legendary, labeller = labeller(Legendary = new_labels)) +labs(title = "Распределение скорости покемонов по критерию легендарности", x = "", y = "Скорость аттаки")

```

```{r}
ggplot(pokemon, aes(x = '', y = pokemon$Sp..Def, group = Legendary, fill =  Legendary)) +
geom_violin(alpha = 0.7, show.legend = FALSE) + facet_wrap(~Legendary, labeller = labeller(Legendary = new_labels)) +labs(title = "Распределение скорости покемонов по критерию легендарности", x = "", y = "Скорость защиты")
```

Таким образом, можно видеть, что все числовые показатели у легендарных покемонов выше, чем у обычных. 


## Анализ данных 

Проведем тесты Шапиро-Уилка, чтобы проверить нормальность распределения компонент результирующей. 

**Нулевая гипотеза: показатель скорости (Speed) распределен нормально.** 

```{r}
shapiro.test(pokemon$Speed)
```

p-value < 0.05, что означает, что нулевая гипотеза неверна. Показатель скорости (Speed) распределен не нормально. 


**Нулевая гипотеза: показатель силы аттаки (Attack) распределен нормально.** 

```{r}
shapiro.test(pokemon$Total)
```
p-value < 0.05, что означает, что нулевая гипотеза неверна. Показатель силы аттаки (Attack) распределен не нормально. 


**Нулевая гипотеза: показатель скорости (Speed Attack) распределен нормально. ** 

```{r}
shapiro.test(pokemon$Sp..Atk)
```

p-value < 0.05, что означает, что нулевая гипотеза неверна. Показатель скорости (Speed Attack) распределен не нормально. 

**Нулевая гипотеза: показатель силы защиты (Defense) распределен нормально. ** 

```{r}
shapiro.test(pokemon$Defense)
```


p-value < 0.05, что означает, что нулевая гипотеза неверна. Показатель силы защиты (Speed Defense) распределен не нормально. 

**Нулевая гипотеза: показатель скорости защиты (Speed Defense) распределен нормально. ** 

```{r}
shapiro.test(pokemon$Sp..Def)
```

p-value < 0.05, что означает, что нулевая гипотеза неверна. Показатель скорости защиты (Speed Defense) распределен не нормально. 

**Нулевая гипотеза: показатель HP распределен нормально. ** 

```{r}
shapiro.test(pokemon$HP)
```
p-value < 0.05, что означает, что нулевая гипотеза неверна. Показатель НР распределен не нормально. 



### Гипотеза 1

**Легендарность положительно связана со всеми показателями покемона** 

Попробуем построить логит модель, показывающую, как влияет изменение предикторов (Speed, Attack, HP, Speed Attack и Speed Defense) на изменение легендарности покемона. Строим модель, указываем тип биноминальной регрессии в аргументе *family*. 

``` {r}
model <- glm(pokemon$Legendary ~ pokemon$Speed + pokemon$HP + pokemon$Attack + pokemon$Defense +pokemon$Sp..Atk + pokemon$Sp..Def, family = binomial(link = "logit"))
summary(model)
```

Становится понятно, что все компоненты модели обладают высокой статистической значимостью. Модель  устойчива. Это означает, что повышение каждого из них на единицу будет влести за собой увеличение шанса того, что покемон станет легендарным. Помимо того, видим, что все значения положительны, что говорит о том, что связь между легендарностью и показателями положительна. 




### Гипотеза 2 
**Нет стихии или поколения, которое бы концентрировало всех легендарных покемонов** 

Построим несколько графиков для подтверждения или опровержения этой гипотезы. 

Сначала докажем, что легендарные покемоны присутствуют во всех поколениях. Построим график при помощи ggplot. Наносим точки,  характеризующие покемонов в разных поколениях по типам, в качестве координаты ординат - их значение результирующего показателя (Total). Аргумент size в  *geom_point* делает размер точек разными: легендарные отмечены жирнее. Перевернем названия типов для удобства восприятия. 

```{r}
ggplot(pokemon, aes(x = Type.1, y = Total)) + geom_point(aes(color = Generation, size = Legendary)) +
labs(title = "Легендарные и обычные покемоны",
x = "Tип покемона", y = "Total") + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Так, можно видеть, что не все типы покемонов становятся легендарными: например, среди  типов Fightning, Bug и Poison нет ни одного особенного. Однако гипотеза состояла в том, что легендарные покемоны не сосредоточены среди одной стихии, и она подтверждается.  Посмотрим на разделение легендарных покемонов по стихиям:

```{r, echo=TRUE}
ap<- pokemon %>% group_by(Type.1, Legendary) %>% summarise(n()) %>% filter(Legendary == '1') %>% select(-(Legendary))
ap
```

Теперь построим аналогичный график для уровней. Используем  столбчатую диаграмму,  при помощи *facet_wrap* разделенную по легендарности. Меняем исходный серый цвет на желтый, добавляем *geom_text* -  количество покемонов в каждом поколении,  заголовки и названия осей. 

```{r}

ggplot(pokemon, aes(x = Generation)) + geom_bar(aes(stat = "identity"), fill = "yellow") + facet_wrap(~Legendary, labeller = labeller(Legendary = new_labels)) +
  geom_text(stat='count', aes(label=..count..), vjust=-1) + labs(title = "Количество легендарных и обычных покемонов по поколениям",
x = "Поколение", y = "Количество") 
```

Как можно видеть, легендарные покемоны присутствуют во всех поколениях, однако большая их часть находится в 3-5 поколениях. Таким образом, гипотеза 2 подтверждается.


Посмотрим на среднюю статистику самых сильных покемонов. Можно видеть, какие сильные и слабые стороны, например покемоны третьего поколения отличаются силой атаки  и защиты, но имеют низший уровень HP. 

```{r}
pokemon %>% group_by(Generation) %>% filter(Legendary == '1') %>% summarize(HP=mean(HP), Attack=mean(Attack),Defense=mean(Defense), Sp..Atk=mean(Sp..Atk), Sp..Def=mean(Sp..Def), Speed=mean(Speed)) %>%  gather(Stats, value, 2:7) %>%
  ggplot(aes(x=Generation, y=value, group=1)) + geom_line(colour="blue") + geom_point() + facet_wrap(~Stats) +
    labs(y="Средняя статистика самых сильных покемонов")

```


## Выводы

На основе данных о покемонах был проведен анализ о положении легендарных "особей". Сначала были охарактеризованы исходные данные, построены скрипичные графики распределения, которые показывают, что все показатели легендарных покемонов выше, чем обычных. Помимо того, графики показали, что количество легендарных в выборке существенно меньше, чем обычных. Для числовых переменных проведены тесты Шапиро, показывающее, что числовые данные, характеризующие возможности покемонов распределены не нормально. 

Также было определено отсутствие паттернов пропущенных значений, распределение стихий покемонов и особей по поколениям  в процентном соотношении.

Далее проверялись гипотезы.  Первая гипотеза: **легендарность положительно связана со всеми показателями покемона**, была проверена при помощи логистической регрессии, где зависимой переменной была легендарность, а предикторами -- все числовые переменные входящие в результирующую (Total). Логит-модель имела высокие показатели значимости, что подтверждает ее устойчивость. Все коэффициенты положительные. Гипотеза подтвердилась.

Вторая гипотеза: **нет стихии или поколения, которое бы концентрировало всех легендарных покемонов**. Для ее проверки были построены два графика. 
Первый показывает, как легендарные покемоны распределены по стихиям. Из него становится понятно, что легендарные покемоны есть не в каждой стихии, но в целом они присутствуют в 15 из 18 категорий, поэтому половина гипотезы подтверждается. 
Второй график показывает количество легендарных и обычных покемонов по поколениям. При помощи него понятно, что в каких поколениях концентрируется большая часть легендарных покемонов, а также общая структура распределения покемонов по уровням. Так подтверждается вторая половина гипотезы -- поколения, концентрирующего всех легендарных покемонов, тоже нет. 










